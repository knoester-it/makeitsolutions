# Introduction
This Terraform code is defining a set of modules that are used to create an Azure OpenAI instance with ChatGPT deployment in Azure.

The sample ChatGPT app is available at https://github.com/microsoft/sample-app-aoai-chatGPT 

# Build and Test
Usage: [Explained](https://learn.microsoft.com/en-us/azure/developer/terraform/
1. terraform init
2. terraform plan -var-file="./environments/production.tfvars" -out main.tfplan
3. terraform apply main.tfplan

# Destroy
1. terraform plan -destroy -var-file="./environments/production.tfvars" -out main.tfplan
2. terraform apply main.tfplan

# Modules Explained
Here is an overview of what each module does.

## Main.tf (root)
This Terraform code sets up a deployment for an "openai" module in Azure. Here's what it does:

-It creates a random string resource named "prefix" with a length of 6 characters and no special, uppercase, or numeric characters.
-It creates an Azure resource group named "rg-${var.name_prefix}-${var.openai_name}-${random_string.prefix.result}". The location and tags are determined by the corresponding variables.

### It includes a module called "keyvault" defined in a separate module file. This module is responsible for creating an Azure Key Vault with specific configurations.

### It defines a module named "openai" with the source located at "./modules/openai".
Within the module, it configures various properties:
- "name" is set to a lowercase value based on conditions. If "var.name_prefix" is null, it uses "${random_string.prefix.result}${var.openai_name}-${random_string.prefix.result}". Otherwise, it uses "${var.name_prefix}-${var.openai_name}-${random_string.prefix.result}".
- "location" is set based on the provided variable value.
- "resource_group_name" is set to the name of the Azure resource group created earlier.
- "sku_name" is set based on the value of the variable "var.openai_sku_name".
- "tags" are set based on the corresponding variable.
- "deployments" are specified based on the value of the variable "var.openai_deployments".
- "custom_subdomain_name" is determined based on conditions. If "var.openai_custom_subdomain_name" is empty or null, it uses a generated value. Otherwise, it uses the provided value.
- "public_network_access_enabled" is set based on the value of the variable "var.openai_public_network_access_enabled".

### It includes a module called "webapp" defined in a separate module file. This module is responsible for creating a web application that utilizes ChatGPT. It depends on the "openai" and "keyvault" modules.

Overall, this code provisions Azure resources, including a resource group, and deploys an "openai" module with configurable settings.

## openai (module)
This Terraform code defines Azure resources for an OpenAI cognitive service deployment. Here's what it does:

-It creates an Azure Cognitive Services account (azurerm_cognitive_account) with the specified configuration, including name, location, resource group, kind ("OpenAI"), custom subdomain name, SKU name, network access settings, tags, and system-assigned identity.
-It specifies a lifecycle block to ignore changes in the tags attribute of the cognitive account.
-It creates an Azure Cognitive Services deployment (azurerm_cognitive_deployment) for each deployment specified in the var.deployments list. Each deployment has a unique name and is associated with the previously created cognitive account.
-Each deployment includes a model with the format "OpenAI" and specific name and version values taken from the corresponding entry in 
var.deployments

-Each deployment also includes a scale block specifying the type as "Standard".

In summary, this code provisions an Azure Cognitive Services account and sets up one or more deployments within that account, each tied to a specific model.

## keyvault (module)
This Terraform code provisions an Azure Key Vault in Microsoft Azure. Here's a breakdown of what it does:
-It imports the Azure client configuration using the azurerm_client_config data source.
-It creates an Azure resource group using the azurerm_resource_group  resource. The resource group name is generated by concatenating various variables and a random string. It also assigns tags to the resource group.
-It generates a random ID using the random_id resource. The generated ID will be used as part of the Key Vault name.
-It creates an Azure Key Vault using the azurerm_key_vault resource. The Key Vault name is generated by concatenating various variables. It configures the Key Vault with encryption, retention, and protection settings.
-It defines an access policy for the Key Vault, allowing specific permissions to a tenant and object (user, group, or service principal). The permissions include key operations, secret operations, and storage operations.

Overall, this code sets up an Azure Key Vault with specific configurations and access policies within an Azure resource group.

## webapp (module)
This Terraform code provisions the following resources in Azure:

-Retrieves information about an Azure subscription using the "azurerm_subscription" data source.
-Retrieves the current Azure AD client configuration using the "azuread_client_config" data source.
-Creates an Azure AD application with a display name and identifier URIs.
-Specifies the owner of the Azure AD application as the current user retrieved from the client configuration.
-Configures the authentication settings for the web app, enabling Azure Active Directory authentication and specifying the necessary parameters.
-Creates an Azure App Service Plan for a Linux-based web app.
-Creates a Linux-based web app with specific configurations such as the service plan, HTTPS-only access, minimum TLS version, and identity type.
-Sets various application settings for the web app, including secrets, API keys, and other environment variables.
-Deploys code from a public GitHub repository to the web app using Azure App Service Source Control.
-Creates a service principal for the web app.
-Generates a secret for the web app's application registration.
-Retrieves information about an Azure Key Vault using the "azurerm_key_vault" data source.
-Stores the web app's secret in the Azure Key Vault as a key vault secret using the "azurerm_key_vault_secret" resource.

In summary, this code sets up an Azure AD application with authentication, provisions a Linux-based web app with code deployment, creates a service principal, and stores secrets in an Azure Key Vault.

## privateendpoint (module)
This code creates an Azure Private Endpoint and a corresponding DNS A record.

-The azurerm_private_endpoint resource defines a private endpoint. It specifies the location, resource group, and subnet where the private endpoint will be created. It also configures a private service connection, which establishes the connection to a specific resource identified by var.private_link_enabled_resource_id. 
-The subresource_names parameter specifies additional subresources to be accessed through the private endpoint.
-The azurerm_private_dns_a_record resource creates a DNS A record in a private DNS zone. It specifies the name of the A record, the private DNS zone's name, and the resource group. The 
records parameter is set to the private IP address of the private endpoint created earlier, allowing the endpoint to be resolved using the specified DNS name within the private DNS zone. The TTL (Time To Live) determines how long the DNS record should be cached before being refreshed.

## vnet (module)
This Terraform code defines three resources in Azure: a virtual network and two subnets.

-The azurerm_virtual_network resource creates a virtual network with the specified name, address space, location, and resource group.
-The azurerm_subnet resource creates a public subnet with the name "public_subnet" and an address prefix of "10.0.1.0/24". It is associated with the previously created virtual network.
-The second azurerm_subnet resource creates an additional subnet named "endpoint_subnet" with the address prefix "10.0.2.0/24". It is also associated with the same virtual network. -Additionally, this subnet has the setting private_endpoint_network_policies_enabled enabled, which indicates that network policies will be enforced on private endpoints within this subnet.

## variables.tf (root)
This Terraform code defines a set of variables that can be used to configure the deployment of Azure resources. Here's a breakdown of each variable:

-name_prefix
An optional prefix for the name of resource groups and resources. It is of type string, has a default value of "Example," and can be set to null.
- environment
A string variable representing the environment (e.g., development, production).
company
A string variable representing the company or organization name.
- location
Specifies the location (Azure region) for the resource group and all resources. It has a default value of "northeurope" but can be modified.
- resource_group_name
Specifies the name of the resource group. It has a default value of "rg" but can be modified.
- openai_name
The required name of the Azure OpenAI Service.
- openai_sku_name
An optional SKU (stock-keeping unit) name for the Azure OpenAI Service. It has a default value of "S0" but can be modified.
- openai_custom_subdomain_name
An optional custom subdomain name for the Azure OpenAI Service. It can be set to null or an empty string.
- openai_public_network_access_enabled
An optional boolean value indicating whether public network access is allowed for the Azure OpenAI Service. It has a default value of true but can be modified.
- openai_deployments
An optional list of deployments for the Azure OpenAI Service. Each deployment includes a name, model (with name and version), and RAI policy name.
- tags
Optional tags to assign to all resources created by the Terraform code. It has a default value that includes a tag "CreatedWith" set to "Terraform."
- sku_name
An optional SKU name for an Azure web app. It has a default value of "B1" but can be modified.